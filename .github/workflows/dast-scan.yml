name: DAST Security Scan

on:
  # Weekly scheduled scan
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  # Manual trigger for ad-hoc scans
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      scan_type:
        description: 'Scan type'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
          - api

jobs:
  dast-scan:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set target URL
      id: set-url
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # For manual scans, use provided URL and scan type
          echo "target_url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
          echo "scan_type=${{ github.event.inputs.scan_type || 'baseline' }}" >> $GITHUB_OUTPUT
        else
          # For scheduled scans, use deployed URL
          echo "target_url=https://echospace-backend-app-dev.azurewebsites.net" >> $GITHUB_OUTPUT
          echo "scan_type=baseline" >> $GITHUB_OUTPUT
        fi
      
    - name: ZAP Baseline Scan
      if: steps.set-url.outputs.scan_type == 'baseline'
      uses: zaproxy/action-baseline@v0.15.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        fail_action: false
        rules_file_name: '.zap/rules.tsv'
      continue-on-error: true
        
    - name: ZAP Full Scan
      if: steps.set-url.outputs.scan_type == 'full'
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        fail_action: true
        rules_file_name: '.zap/rules.tsv'
        
    - name: ZAP API Scan
      if: steps.set-url.outputs.scan_type == 'api'
      uses: zaproxy/action-api-scan@v0.7.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        format: openapi
        api: '${{ steps.set-url.outputs.target_url }}/swagger/v1/swagger.json'
        fail_action: true
        
    - name: Upload ZAP results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-results
        path: |
          report_html.html
          report_json.json
          report_md.md
          zap-report.html
          zap-results.json
        retention-days: 30
        
    - name: Check for high/critical findings
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // Try to find the report file (it might have a different name)
          let reportFile = 'report_json.json';
          if (!fs.existsSync(reportFile)) {
            reportFile = 'zap-results.json';
          }
          
          if (fs.existsSync(reportFile)) {
            try {
              const results = JSON.parse(fs.readFileSync(reportFile, 'utf8'));
              const site = results.site || (results[0] && results[0].site) || [];
              const alerts = site[0]?.alerts || [];
              
              const highAlerts = alerts.filter(a => a.risk === 'High' || a.risk === 'Critical');
              
              // Fail the workflow if high/critical issues found
              if (highAlerts.length > 0) {
                core.setFailed(`Found ${highAlerts.length} high/critical security issues. Check workflow artifacts for full report.`);
              }
            } catch (error) {
              console.log('Error processing results:', error.message);
              // Don't fail the workflow if we can't parse results
            }
          } else {
            console.log('Report file not found');
          }

