name: DAST Security Scan

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      scan_type:
        description: 'Scan type'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
          - api
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'

jobs:
  dast-scan:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set target URL
      id: set-url
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For PRs, use staging URL (update this to your staging environment)
          echo "target_url=https://echospace-backend-app-dev.azurewebsites.net" >> $GITHUB_OUTPUT
          echo "scan_type=baseline" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "target_url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
          echo "scan_type=${{ github.event.inputs.scan_type || 'baseline' }}" >> $GITHUB_OUTPUT
        else
          # For scheduled scans, use production URL
          echo "target_url=https://echospace-backend-app-dev.azurewebsites.net" >> $GITHUB_OUTPUT
          echo "scan_type=baseline" >> $GITHUB_OUTPUT
        fi
      
    - name: Setup OWASP ZAP
      uses: zaproxy/action-baseline@v0.15.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        
    - name: ZAP Baseline Scan
      if: steps.set-url.outputs.scan_type == 'baseline' || github.event_name == 'pull_request'
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        fail_action: true
        rules_file_name: '.zap/rules.tsv'
        
    - name: ZAP Full Scan
      if: steps.set-url.outputs.scan_type == 'full'
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        fail_action: true
        rules_file_name: '.zap/rules.tsv'
        
    - name: ZAP API Scan
      if: steps.set-url.outputs.scan_type == 'api'
      uses: zaproxy/action-api-scan@v0.7.0
      with:
        target: ${{ steps.set-url.outputs.target_url }}
        format: openapi
        api: '${{ steps.set-url.outputs.target_url }}/swagger/v1/swagger.json'
        fail_action: true
        
    - name: Upload ZAP results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-results
        path: |
          zap-report.html
          zap-results.json
        retention-days: 30
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('zap-results.json')) {
            const results = JSON.parse(fs.readFileSync('zap-results.json', 'utf8'));
            const alerts = results.site?.[0]?.alerts || [];
            const highAlerts = alerts.filter(a => a.risk === 'High' || a.risk === 'Critical');
            
            if (highAlerts.length > 0) {
              core.setFailed(`Found ${highAlerts.length} high/critical security issues`);
            }
          }

