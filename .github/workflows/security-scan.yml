name: Security Scanning

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Terraform Security Scanning (Checkov)
  terraform-security:
    name: Terraform Security Scan (Checkov)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Checkov
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: terraform/
        framework: terraform
        soft_fail: false
        # Fail on HIGH and CRITICAL severity issues
        check: CKV_AZURE_1,CKV_AZURE_2,CKV_AZURE_3,CKV_AZURE_4,CKV_AZURE_5,CKV_AZURE_8,CKV_AZURE_9,CKV_AZURE_10,CKV_AZURE_12,CKV_AZURE_13,CKV_AZURE_18,CKV_AZURE_19,CKV_AZURE_20,CKV_AZURE_21,CKV_AZURE_23,CKV_AZURE_24,CKV_AZURE_25,CKV_AZURE_26,CKV_AZURE_27,CKV_AZURE_28,CKV_AZURE_29,CKV_AZURE_30,CKV_AZURE_31,CKV_AZURE_32,CKV_AZURE_33,CKV_AZURE_34,CKV_AZURE_35,CKV_AZURE_36,CKV_AZURE_37,CKV_AZURE_38,CKV_AZURE_39,CKV_AZURE_40,CKV_AZURE_41,CKV_AZURE_42,CKV_AZURE_43,CKV_AZURE_44,CKV_AZURE_45,CKV_AZURE_46,CKV_AZURE_47,CKV_AZURE_48,CKV_AZURE_49,CKV_AZURE_50,CKV_AZURE_51,CKV_AZURE_52,CKV_AZURE_53,CKV_AZURE_54,CKV_AZURE_55,CKV_AZURE_56,CKV_AZURE_57,CKV_AZURE_58,CKV_AZURE_59,CKV_AZURE_60,CKV_AZURE_61,CKV_AZURE_62,CKV_AZURE_63,CKV_AZURE_64,CKV_AZURE_65,CKV_AZURE_66,CKV_AZURE_67,CKV_AZURE_68,CKV_AZURE_69,CKV_AZURE_70,CKV_AZURE_71,CKV_AZURE_72,CKV_AZURE_73,CKV_AZURE_74,CKV_AZURE_75,CKV_AZURE_76,CKV_AZURE_77,CKV_AZURE_78,CKV_AZURE_79,CKV_AZURE_80,CKV_AZURE_81,CKV_AZURE_82,CKV_AZURE_83,CKV_AZURE_84,CKV_AZURE_85,CKV_AZURE_86,CKV_AZURE_87,CKV_AZURE_88,CKV_AZURE_89,CKV_AZURE_90,CKV_AZURE_91,CKV_AZURE_92,CKV_AZURE_93,CKV_AZURE_94,CKV_AZURE_95,CKV_AZURE_96,CKV_AZURE_97,CKV_AZURE_98,CKV_AZURE_99,CKV_AZURE_100,CKV_AZURE_101,CKV_AZURE_102,CKV_AZURE_103,CKV_AZURE_104,CKV_AZURE_105,CKV_AZURE_106,CKV_AZURE_107,CKV_AZURE_108,CKV_AZURE_109,CKV_AZURE_110,CKV_AZURE_111,CKV_AZURE_112,CKV_AZURE_113,CKV_AZURE_114,CKV_AZURE_115,CKV_AZURE_116,CKV_AZURE_117,CKV_AZURE_118,CKV_AZURE_119,CKV_AZURE_120,CKV_AZURE_121,CKV_AZURE_122,CKV_AZURE_123,CKV_AZURE_124,CKV_AZURE_125,CKV_AZURE_126,CKV_AZURE_127,CKV_AZURE_128,CKV_AZURE_129,CKV_AZURE_130,CKV_AZURE_131,CKV_AZURE_132,CKV_AZURE_133,CKV_AZURE_134,CKV_AZURE_135,CKV_AZURE_136,CKV_AZURE_137,CKV_AZURE_138,CKV_AZURE_139,CKV_AZURE_140,CKV_AZURE_141,CKV_AZURE_142,CKV_AZURE_143,CKV_AZURE_144,CKV_AZURE_145,CKV_AZURE_146,CKV_AZURE_147,CKV_AZURE_148,CKV_AZURE_149,CKV_AZURE_150,CKV_AZURE_151,CKV_AZURE_152,CKV_AZURE_153,CKV_AZURE_154,CKV_AZURE_155,CKV_AZURE_156,CKV_AZURE_157,CKV_AZURE_158,CKV_AZURE_159,CKV_AZURE_160,CKV_AZURE_161,CKV_AZURE_162,CKV_AZURE_163,CKV_AZURE_164,CKV_AZURE_165,CKV_AZURE_166,CKV_AZURE_167,CKV_AZURE_168,CKV_AZURE_169,CKV_AZURE_170,CKV_AZURE_171,CKV_AZURE_172,CKV_AZURE_173,CKV_AZURE_174,CKV_AZURE_175,CKV_AZURE_176,CKV_AZURE_177,CKV_AZURE_178,CKV_AZURE_179,CKV_AZURE_180,CKV_AZURE_181,CKV_AZURE_182,CKV_AZURE_183,CKV_AZURE_184,CKV_AZURE_185,CKV_AZURE_186,CKV_AZURE_187,CKV_AZURE_188,CKV_AZURE_189,CKV_AZURE_190,CKV_AZURE_191,CKV_AZURE_192,CKV_AZURE_193,CKV_AZURE_194,CKV_AZURE_195,CKV_AZURE_196,CKV_AZURE_197,CKV_AZURE_198,CKV_AZURE_199,CKV_AZURE_200
        # Output format
        output_format: sarif
        output_file_path: checkov-results.sarif
        
    - name: Upload Checkov results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: checkov-results.sarif
        category: checkov

  # Secrets Scanning (Gitleaks)
  secrets-scan:
    name: Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better secret detection
      
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # Fail on secrets found
        no-git: false
        verbose: true

  # .NET Dependency Vulnerability Scanning
  dotnet-dependencies:
    name: .NET Dependency Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore .NET dependencies
      run: dotnet restore EchoSpace.CleanArchitecture.sln
      
    - name: Check for vulnerable packages
      id: check-vulnerabilities
      run: |
        echo "Checking for vulnerable .NET packages..."
        dotnet list package --vulnerable --include-transitive || true
        
        # Count vulnerable packages
        VULN_COUNT=$(dotnet list package --vulnerable --include-transitive 2>/dev/null | grep -c "vulnerable" || echo "0")
        echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$VULN_COUNT" -gt "0" ]; then
          echo "⚠️ Found vulnerable packages!"
          dotnet list package --vulnerable --include-transitive
          exit 1
        else
          echo "✅ No vulnerable packages found"
        fi

  # Node.js/Angular Dependency Vulnerability Scanning
  node-dependencies:
    name: Node.js Dependency Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/EchoSpace.Web.Client/package-lock.json'
        
    - name: Install dependencies
      working-directory: src/EchoSpace.Web.Client
      run: npm ci
      
    - name: Run npm audit
      working-directory: src/EchoSpace.Web.Client
      run: |
        echo "Running npm audit..."
        npm audit --audit-level=moderate || true
        
        # Check for high or critical vulnerabilities
        npm audit --audit-level=high --json > audit-results.json || true
        
        HIGH_CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' || echo "0")
        
        if [ "$HIGH_CRITICAL" -gt "0" ]; then
          echo "⚠️ Found high or critical vulnerabilities!"
          npm audit --audit-level=high
          exit 1
        else
          echo "✅ No high or critical vulnerabilities found"
        fi

  # .NET SAST Scanning (Security Code Scan)
  dotnet-sast:
    name: .NET SAST Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Install Security Code Scan
      run: |
        dotnet tool install --global security-scan || true
        dotnet tool update --global security-scan || true
        
    - name: Restore .NET dependencies
      run: dotnet restore EchoSpace.CleanArchitecture.sln
      
    - name: Build solution
      run: dotnet build EchoSpace.CleanArchitecture.sln --configuration Release --no-restore
      
    - name: Run Security Code Scan
      continue-on-error: true
      run: |
        echo "Running Security Code Scan..."
        # Security Code Scan runs as MSBuild target
        dotnet build EchoSpace.CleanArchitecture.sln --configuration Release /p:SecurityCodeScan=true || true
        
    - name: Check for security issues
      run: |
        if [ -f "SecurityCodeScanReport.html" ]; then
          echo "⚠️ Security Code Scan report generated"
          # In a real scenario, you'd parse the report and fail on critical issues
        else
          echo "✅ No security issues found (or report not generated)"
        fi

  # TypeScript/JavaScript SAST Scanning (ESLint Security)
  typescript-sast:
    name: TypeScript SAST Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/EchoSpace.Web.Client/package-lock.json'
        
    - name: Install dependencies
      working-directory: src/EchoSpace.Web.Client
      run: npm ci
      
    - name: Install ESLint security plugin
      working-directory: src/EchoSpace.Web.Client
      run: |
        npm install --save-dev eslint-plugin-security || true
        
    - name: Run ESLint with security rules
      working-directory: src/EchoSpace.Web.Client
      continue-on-error: true
      run: |
        echo "Running ESLint security scan..."
        npx eslint "src/**/*.ts" --ext .ts --format json --output-file eslint-security-report.json || true
        
    - name: Check ESLint results
      working-directory: src/EchoSpace.Web.Client
      run: |
        if [ -f "eslint-security-report.json" ]; then
          echo "ESLint security report generated"
          # Check for security-related errors
          SECURITY_ISSUES=$(cat eslint-security-report.json | jq '[.[] | select(.messages[] | .ruleId | contains("security"))] | length' || echo "0")
          if [ "$SECURITY_ISSUES" -gt "0" ]; then
            echo "⚠️ Found security issues in TypeScript code"
            exit 1
          else
            echo "✅ No security issues found"
          fi
        fi

  # SBOM Generation
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # .NET SBOM
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Install CycloneDX .NET tool
      run: |
        dotnet tool install --global CycloneDX || true
        dotnet tool update --global CycloneDX || true
        
    - name: Generate .NET SBOM
      run: |
        echo "Generating .NET SBOM..."
        dotnet CycloneDX EchoSpace.CleanArchitecture.sln -o sbom/
        ls -la sbom/
        
    # Node.js SBOM
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install CycloneDX npm tool
      run: npm install -g @cyclonedx/cyclonedx-npm || true
        
    - name: Generate Node.js SBOM
      working-directory: src/EchoSpace.Web.Client
      run: |
        echo "Generating Node.js SBOM..."
        cyclonedx-npm --output-file ../../../sbom/npm-sbom.json
        
    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-files
        path: sbom/
        retention-days: 30

  # Terraform Validation
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        
    - name: Terraform Format Check
      working-directory: terraform
      run: terraform fmt -check -recursive
      
    - name: Terraform Init
      working-directory: terraform
      continue-on-error: true
      run: terraform init
      
    - name: Terraform Validate
      working-directory: terraform
      continue-on-error: true
      run: terraform validate
      
    - name: Terraform Plan (Dry Run)
      working-directory: terraform
      continue-on-error: true
      run: terraform plan -out=tfplan

