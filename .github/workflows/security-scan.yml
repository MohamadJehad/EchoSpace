name: Security Scanning

on:
  pull_request:  # Run on all pull requests, regardless of target branch
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Terraform Security Scanning (Checkov)
  # DISABLED: Temporarily disabled due to configuration issues
  # terraform-security:
  #   name: Terraform Security Scan (Checkov)
  #   runs-on: ubuntu-latest
  #   if: false  # Disabled
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Run Checkov
  #     id: checkov
  #     uses: bridgecrewio/checkov-action@master
  #     with:
  #       directory: terraform/
  #       framework: terraform
  #       soft_fail: true
  #       output_format: sarif
  #       output_file_path: checkov-results.sarif
  #       
  #   - name: Upload Checkov results to GitHub Security
  #     uses: github/codeql-action/upload-sarif@v4
  #     if: always()
  #     with:
  #       sarif_file: checkov-results.sarif
  #       category: checkov

  # Secrets Scanning (Gitleaks)
  secrets-scan:
    name: Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better secret detection
      
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # .NET Dependency Vulnerability Scanning
  dotnet-dependencies:
    name: .NET Dependency Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore .NET dependencies
      run: dotnet restore EchoSpace.CleanArchitecture.sln
      
    - name: Check for vulnerable packages
      id: check-vulnerabilities
      run: |
        echo "Checking for vulnerable .NET packages..."
        dotnet list package --vulnerable --include-transitive || true
        
        # Check for high/critical vulnerabilities specifically
        VULN_OUTPUT=$(dotnet list package --vulnerable --include-transitive 2>&1 || true)
        
        # Count high and critical vulnerabilities
        HIGH_CRITICAL=$(echo "$VULN_OUTPUT" | grep -iE "(High|Critical)" | wc -l || echo "0")
        
        if [ "$HIGH_CRITICAL" -gt "0" ]; then
          echo "⚠️ Found $HIGH_CRITICAL high or critical vulnerabilities!"
          echo ""
          echo "Vulnerable packages:"
          dotnet list package --vulnerable --include-transitive
          echo ""
          echo "Attempting to update packages..."
          dotnet list package --outdated || true
          echo ""
          echo "::warning::High or critical .NET vulnerabilities detected. Please update packages."
          echo "Run 'dotnet list package --outdated' to see available updates."
          echo "Run 'dotnet add package <PackageName> --version <Version>' to update."
          # Don't fail the build - just warn (you can change this to exit 1 if you want strict enforcement)
        else
          # Check for any vulnerabilities (moderate included)
          VULN_COUNT=$(echo "$VULN_OUTPUT" | grep -c "vulnerable" || echo "0")
          if [ "$VULN_COUNT" -gt "0" ]; then
            echo "⚠️ Found moderate vulnerabilities (non-blocking)"
            dotnet list package --vulnerable --include-transitive
            echo "::notice::Moderate .NET vulnerabilities detected. Consider updating packages."
          else
            echo "✅ No vulnerable packages found"
          fi
        fi

  # Node.js/Angular Dependency Vulnerability Scanning
  node-dependencies:
    name: Node.js Dependency Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/EchoSpace.Web.Client/package-lock.json'
        
    - name: Install dependencies
      working-directory: src/EchoSpace.Web.Client
      run: npm ci
      
    - name: Run npm audit
      working-directory: src/EchoSpace.Web.Client
      run: |
        echo "Running npm audit..."
        npm audit --audit-level=moderate || true
        
        # Check for high or critical vulnerabilities
        npm audit --audit-level=high --json > audit-results.json 2>&1 || true
        
        # Parse results (handle both success and failure cases)
        if [ -f audit-results.json ]; then
          HIGH_CRITICAL=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          
          if [ "$HIGH_CRITICAL" != "null" ] && [ "$HIGH_CRITICAL" -gt "0" ]; then
            echo "⚠️ Found $HIGH_CRITICAL high or critical vulnerabilities!"
            echo "Attempting to fix automatically..."
            npm audit fix --force || true
            echo ""
            echo "Please review and update package.json if needed"
            echo "Run 'npm audit fix' locally to update package-lock.json"
            # Don't fail the build - just warn (you can change this to exit 1 if you want strict enforcement)
            echo "::warning::High or critical npm vulnerabilities detected. Please update packages."
          else
            echo "✅ No high or critical vulnerabilities found"
          fi
        else
          echo "⚠️ Could not parse audit results, showing full audit:"
          npm audit --audit-level=high || true
          echo "::warning::npm audit check completed with warnings"
        fi

  # .NET SAST Scanning (Security Code Scan)
  dotnet-sast:
    name: .NET SAST Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Install Security Code Scan
      run: |
        dotnet tool install --global security-scan || true
        dotnet tool update --global security-scan || true
        
    - name: Restore .NET dependencies
      run: dotnet restore EchoSpace.CleanArchitecture.sln
      
    - name: Build solution
      run: dotnet build EchoSpace.CleanArchitecture.sln --configuration Release --no-restore
      
    - name: Run Security Code Scan
      continue-on-error: true
      run: |
        echo "Running Security Code Scan..."
        # Security Code Scan runs as MSBuild target
        dotnet build EchoSpace.CleanArchitecture.sln --configuration Release /p:SecurityCodeScan=true || true
        
    - name: Check for security issues
      run: |
        if [ -f "SecurityCodeScanReport.html" ]; then
          echo "⚠️ Security Code Scan report generated"
          # In a real scenario, you'd parse the report and fail on critical issues
        else
          echo "✅ No security issues found (or report not generated)"
        fi

  # TypeScript/JavaScript SAST Scanning (ESLint Security)
  typescript-sast:
    name: TypeScript SAST Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/EchoSpace.Web.Client/package-lock.json'
        
    - name: Install dependencies
      working-directory: src/EchoSpace.Web.Client
      run: npm ci
      
    - name: Install ESLint security plugin
      working-directory: src/EchoSpace.Web.Client
      run: |
        npm install --save-dev eslint-plugin-security || true
        
    - name: Run ESLint with security rules
      working-directory: src/EchoSpace.Web.Client
      continue-on-error: true
      run: |
        echo "Running ESLint security scan..."
        npx eslint "src/**/*.ts" --ext .ts --format json --output-file eslint-security-report.json || true
        
    - name: Check ESLint results
      working-directory: src/EchoSpace.Web.Client
      run: |
        if [ -f "eslint-security-report.json" ]; then
          echo "ESLint security report generated"
          # Check for security-related errors
          SECURITY_ISSUES=$(cat eslint-security-report.json | jq '[.[] | select(.messages[] | .ruleId | contains("security"))] | length' || echo "0")
          if [ "$SECURITY_ISSUES" -gt "0" ]; then
            echo "⚠️ Found security issues in TypeScript code"
            exit 1
          else
            echo "✅ No security issues found"
          fi
        fi

  # SBOM Generation
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # .NET SBOM
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Install CycloneDX .NET tool
      run: |
        dotnet tool install --global CycloneDX || true
        dotnet tool update --global CycloneDX || true
        
    - name: Generate .NET SBOM
      run: |
        echo "Generating .NET SBOM in JSON format..."
        mkdir -p sbom
        dotnet CycloneDX EchoSpace.CleanArchitecture.sln -o sbom/ -f json
        # Find and rename the generated JSON file to a clear name
        JSON_FILE=$(find sbom/ -name "*.json" -type f | head -1)
        if [ -n "$JSON_FILE" ] && [ "$JSON_FILE" != "sbom/dotnet-sbom.json" ]; then
          mv "$JSON_FILE" sbom/dotnet-sbom.json
          echo "Renamed $JSON_FILE to sbom/dotnet-sbom.json"
        fi
        echo "SBOM files generated:"
        ls -la sbom/
        
    # Node.js SBOM
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: 'src/EchoSpace.Web.Client/package-lock.json'
        
    - name: Install dependencies
      working-directory: src/EchoSpace.Web.Client
      run: npm ci
        
    - name: Install CycloneDX npm tool
      run: npm install -g @cyclonedx/cyclonedx-npm || true
        
    - name: Generate Node.js SBOM
      working-directory: src/EchoSpace.Web.Client
      run: |
        echo "Generating Node.js SBOM in JSON format..."
        cyclonedx-npm --output-file ../../../sbom/angular-sbom.json --output-format json

    - name: Verify SBOM JSON Format
      run: |
        echo "Verifying SBOM files are valid JSON..."
        if [ -f sbom/dotnet-sbom.json ]; then
          echo "✓ .NET SBOM found: dotnet-sbom.json"
          python3 -m json.tool sbom/dotnet-sbom.json > /dev/null && echo "  ✓ Valid JSON format" || echo "  ✗ Invalid JSON"
        else
          echo "✗ .NET SBOM file not found"
        fi
        
        if [ -f sbom/angular-sbom.json ]; then
          echo "✓ Angular SBOM found: angular-sbom.json"
          python3 -m json.tool sbom/angular-sbom.json > /dev/null && echo "  ✓ Valid JSON format" || echo "  ✗ Invalid JSON"
        else
          echo "✗ Angular SBOM file not found"
        fi
        
        echo ""
        echo "SBOM files ready for upload:"
        ls -lh sbom/*.json 2>/dev/null || echo "No JSON files found in sbom/"

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-files
        path: sbom/
        retention-days: 30

  # Terraform Validation
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        
    - name: Terraform Format Check
      working-directory: terraform
      run: terraform fmt -check -recursive
      
    - name: Terraform Init
      working-directory: terraform
      continue-on-error: true
      run: terraform init
      
    - name: Terraform Validate
      working-directory: terraform
      continue-on-error: true
      run: terraform validate
      
    - name: Terraform Plan (Dry Run)
      working-directory: terraform
      continue-on-error: true
      run: terraform plan -out=tfplan

